---
- hosts: test
  become: true
  tasks:
    - name: Clean up previous script files to ensure a fresh copy
      # FIX: Add this task to delete the old directory first.
      ansible.builtin.file:
        path: /tmp/semaphore/project_1/repository_1_template_2
        state: absent

    - name: Create a directory if it does not exist
      ansible.builtin.file:
        path: /tmp/semaphore/project_1/repository_1_template_2
        state: directory
        mode: '0755'

    - name: Copy the new_users script to the remote server
      ansible.builtin.copy:
        src: new_users.sh
        dest: /tmp/semaphore/project_1/repository_1_template_2/new_users.sh
        mode: '0755'

    - name: Copy the users CSV file to the remote server
      ansible.builtin.copy:
        src: users.csv
        dest: /tmp/semaphore/project_1/repository_1_template_2/users.csv

    - name: Execute the script with the CSV file as an argument
      ansible.builtin.shell:
        cmd: ./new_users.sh users.csv
        chdir: /tmp/semaphore/project_1/repository_1_template_2
